# :seven: Déploiement

## La mise en production

- [**Mettre en production**]{.orange} : faire [**vivre**]{.blue2} une application dans l'espace de ses [**utilisateurs**]{.blue2}
    - [**Service**]{.orange} : [**déployer**]{.blue2} l'application dans un [**format**]{.blue2} qui répond aux [**besoins**]{.blue2} des utilisateurs potentiels
    - [**Faire vivre**]{.orange} : 
        - [**Superviser**]{.blue2} l'application pour la rendre performante
        - Favoriser l'[**amélioration continue**]{.blue2}

- L'objectif de ce chapitre est de convertir un [**projet maintenable et portable**]{.orange} en un [**service exploitable**]{.orange}

## Un sujet large

- Les [**questions essentielles**]{.orange} à se poser :
    - Quel [**format adapté**]{.blue2} pour répondre aux [**besoins**]{.blue2} ?
    - Quelle [**infrastructure de production**]{.blue2} pour assurer la [**performance**]{.blue2} et le [**passage à l'échelle**]{.blue2} ?
    - Comment [**superviser**]{.blue2} l'application pour assurer sa [**résilience**]{.blue2} en production ?
    - Comment [**automatiser**]{.blue2} le processus de déploiement pour permettre l'[**amélioration continue**]{.blue2} ?

- De nombreuses [**solutions techniques**]{.orange} possibles
    - Présentation des [**concepts standards**]{.blue2}

## Formats de valorisation

- [**Critères**]{.orange} à prendre en compte :
    - Quels sont les [**utilisateurs**]{.blue2} potentiels ?
    - Quels sont leurs [**besoins**]{.blue2} ?

- Exemple "fil rouge" : comment [**servir un projet de ML**]{.orange} à ses utilisateurs potentiels ?

## Servir un projet de ML

- Mettre à disposition le [**code**]{.orange} pour entraîner le modèle
    - [**Reproductible**]{.blue2}... si on a les [**données**]{.blue2} et les [**ressources**]{.blue2}

- Mettre à disposition le [**modèle entraîné**]{.orange}
    - [**Audience technique**]{.blue2} et [**adhérence**]{.blue2} au *framework* d'entraînement du modèle

- Exposer le modèle via une [**API**]{.orange}
    - [**Audience technique**]{.blue2} mais plus large car [**interopérable**]{.blue2}

- Exposer le modèle via une [**interface interactive**]{.orange}
    - [**Audience large**]{.blue2} mais plus [**coûteux**]{.blue2}

## Servir un modèle de ML via une API

- Construire une [**API**]{.orange} pour [**servir**]{.orange} le modèle
    - [**Interface**]{.blue2} entre [**l'utilisateur**]{.blue2} et le [**modèle**]{.blue2} entraîné

![Source : [https://machinelearningmastery.com](https://machinelearningmastery.com/a-practical-guide-to-deploying-machine-learning-models/)](img/api-serve-ml-model.png){fig-align="center" height=350 .fragment}

## Les APIs : définition formelle

> Une API (*application programming interface*) est une **interface logicielle** qui permet de « connecter » un logiciel ou un service à un autre logiciel ou service afin d’échanger des données et des fonctionnalités.
>
> [CNIL](https://www.cnil.fr/fr/definition/interface-de-programmation-dapplication-api)

- Définition peu informative : avec cette définition tout est plus ou moins une API...

## Les APIs : définition opérationnelle

- Une [**API**]{.orange} est un [**contrat logiciel**]{.orange} qui définit :
    - Ce que l'on peut [**demander**]{.blue2}
    - Sous quel [**format**]{.blue2}
    - Ce que l'on [**reçoit en retour**]{.blue2}

- Une [**API**]{.orange} permet à deux systèmes de communiquer [**sans exposer leur implémentation interne**]{.orange}

## Les APIs REST

- [**API RESTful**]{.orange} : API conforme au style d'architecture [REST](https://fr.wikipedia.org/wiki/Representational_state_transfer)
    - Repose sur le [**protocole HTTP**]{.blue2}

![Source : [apisec.ai](https://www.apisec.ai/blog/rest-api-and-its-significance-to-web-service-providers)](img/api-rest.png){fig-align="center" height=400 .fragment}

## Exemples d'API REST

- [**Le client**]{.blue2} : 
    - envoie des [**requêtes HTTP**]{.blue2} (`GET`, `POST`, etc.)
    - à un [**serveur**]{.blue2} accessible depuis une [**URL**]{.blue2}
    - sur un certain [**endpoint**]{.blue2} qui expose le [**service**]{.blue2}

. . .

Exemple : [https://api-adresse.data.gouv.fr/search/?q=comédie&type=street](https://api-adresse.data.gouv.fr/search/?q=comédie&type=street)

- Le [**serveur**]{.blue2} renvoie une [**réponse**]{.blue2} : un [code retour](https://restfulapi.net/http-status-codes/) et de la donnée (en l'absence d'erreur), souvent au format `JSON`

## Architecture cible

- Construire une [**API**]{.orange} pour [**servir**]{.orange} le modèle
    - [**Interface**]{.blue2} entre [**l'utilisateur**]{.blue2} et le [**modèle**]{.blue2} entraîné

. . .

![](img/api-no-mlflow.png){fig-align="center" height=400}

## De l’API locale au service déployé

- On a les outils pour [**construire une API locale**]{.orange}
    - Du [**code applicatif**]{.blue2} auquel il faut rajouter une [**API**]{.blue2}
    - Une [**couche de stockage**]{.blue2} pour le modèle entraîné
    - La [**conteneurisation**]{.blue2} pour encapsuler l'application

- Il nous manque des outils pour en faire un [**service déployé et résilient**]{.orange}
    - Un [**environnement de production**]{.blue2} pour le déploiement
    - Des [**outils de supervision**]{.blue2} pour gérer la charge
    - Des [**outils d'automatisation**]{.blue2} pour l'amélioration en continu de l'application

## Environnement de production

- Dépend essentiellement de l'infrastructure à disposition

- [**Propriétés recherchées**]{.orange} :
    - Adapter les ressources ([**scaler**]{.blue2}) selon les besoins
    - Déploiements [**reproductibles**]{.blue2} et [**automatisés**]{.blue2}
    - [**Monitoring**]{.blue2} de l'état de santé des applications

- Solution : utiliser un [**orchestrateur de conteneurs**]{.orange}
    - Base du `SSP Cloud` : [Kubernetes](https://kubernetes.io/fr/)

![](img/kubernetes-logo.png){fig-align="center" height=100 .fragment}

## Fonctionnement de Kubernetes

- [**Approche *Infrastructure As Code***]{.orange} : on déclare l'[**état désiré du déploiement**]{.blue2}, `Kubernetes` s’assure en continu qu’il correspond à l'[**état réel**]{.blue2}

![Source : [DBA Consulting Blog](https://drsalbertspijkers.blogspot.com/2017/06/red-hat-openshift-and-orchestrating.html)](img/kubernetes-archi.png){fig-align="center" height=400 .fragment}

## L'approche CI/CD

- [**Intégration continue**]{.orange} (CI) : chaque commit déclenche un processus "[**test, build and release**]{.blue2}"
    - `GitHub` {{< fa brands github >}} : [GitHub Actions](https://github.com/features/actions)
    - `GitLab` {{< fa brands gitlab >}} : [GitLab CI/CD](https://docs.gitlab.com/ee/ci/)

- [**Déploiement continu**]{.orange} (CD) : les nouvelles [**releases**]{.blue2} sont automatiquement déployées
    - Sur le `SSP Cloud` : [ArgoCD](https://argo-cd.readthedocs.io/en/stable/)

## CI : implémentation

- [**Principe**]{.orange} : commit -> exécution d'une série d'étapes
    - Script exécuté sur une VM : [***runner***]{.blue2}
    - Mise à disposition d'un *output* : [***artifact***]{.blue2}

- [**Multiples outputs possibles**]{.orange}
    - [Image Docker](https://github.com/ensae-reproductibilite/application-correction/blob/appli19b/.github/workflows/prod.yml)
    - [Slides](https://github.com/ensae-reproductibilite/slides/blob/main/.github/workflows/publish.yaml)
    - [Site internet](https://github.com/ensae-reproductibilite/website/blob/main/.github/workflows/publish.yaml)

## CI : anatomie d'un fichier de CI {.scrollable}

- Spécification : fichier `.yaml` qui paramétrise le *runner*
    - ⚠️ Situé dans le dossier `.github/workflows/`

. . .

```{.yaml filename=".github/workflows/ci.yaml"}
name: Build Docker image

on:
  push:
    branches:
      - main
    tags:

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ensae-reproductibilite/api-titanic
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
```

## CI/CD : implémentation sur `Kubernetes`

![](img/ci-cd.png){fig-align="center" height=300}

## Conclusion

- On a construit un pipeline [**reproductible**]{.orange} et [**automatisé**]{.orange}

![Source : [ibm.com](https://public.dhe.ibm.com/software/data/sw-library/analytics/data-science-lifecycle/#model-implementation)](img/exploration-production.png){fig-align="center" height=250 .fragment}

- Comment tenir compte des [**spécificités du ML**]{.orange} ?
    - [**Approche MLOps**]{.blue2}


# Application

## Mise en production

- Consignes sur le [site du cours](https://ensae-reproductibilite.github.io/website/chapters/application.html)
    - Partie :four: : [**automatisation**]{.blue2} de la livraison d'une application avec l’[**intégration continue**]{.blue2}
    - Partie :five: : [**déploiement**]{.blue2} d'une application et [**industrialisation**]{.blue2}
